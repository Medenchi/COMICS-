<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель</title>
    <!-- Скрипт для интеграции с Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Встроенные CSS стили */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');

        :root {
            --primary-color: #28a745;
            --background-color: #f0f2f5;
            --text-color: #333;
            --card-bg: #ffffff;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
            --input-border: #ced4da;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .admin-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            box-sizing: border-box; /* Важно для корректной ширины */
        }
        
        .form-group input[type="file"] {
            padding: 5px;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .submit-btn:disabled {
            background-color: #94d8a2;
            cursor: not-allowed;
        }

        .submit-btn:hover:not(:disabled) {
            background-color: #218838;
        }

        #status {
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
            display: none; /* Скрыт по умолчанию */
        }
        
        #status.success {
            background-color: #d4edda;
            color: #155724;
        }

        #status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        #status.loading {
            background-color: #cce5ff;
            color: #004085;
        }
    </style>
</head>
<body>

    <div class="admin-container">
        <h1>Создать новую статью</h1>
        <form id="comic-form">
            <div class="form-group">
                <label for="title">Название комикса</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="images">Страницы комикса (можно выбрать несколько)</label>
                <input type="file" id="images" name="images" multiple required accept="image/*">
            </div>
            <button type="submit" class="submit-btn" id="submit-btn">Создать</button>
        </form>
        <div id="status"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

    <script>
        // --- ВАЖНО: ЗАМЕНИТЕ ЭТИ ДАННЫЕ НА ВАШИ ДАННЫЕ ИЗ FIREBASE ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // -----------------------------------------------------------

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Элементы DOM
        const form = document.getElementById('comic-form');
        const titleInput = document.getElementById('title');
        const imagesInput = document.getElementById('images');
        const submitBtn = document.getElementById('submit-btn');
        const statusEl = document.getElementById('status');
        
        function showStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = type; // success, error, loading
            statusEl.style.display = 'block';
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = titleInput.value;
            const files = imagesInput.files;

            if (!title || files.length === 0) {
                showStatus('Пожалуйста, заполните все поля.', 'error');
                return;
            }

            submitBtn.disabled = true;
            showStatus('Загрузка изображений...', 'loading');

            try {
                const imageUrls = [];
                // Создаем массив промисов для загрузки всех файлов
                const uploadPromises = Array.from(files).map(file => {
                    // Создаем уникальное имя файла, чтобы избежать перезаписи
                    const fileName = `${Date.now()}-${file.name}`;
                    const storageRef = storage.ref(`comics/${fileName}`);
                    
                    // Возвращаем промис загрузки
                    return storageRef.put(file).then(snapshot => {
                        return snapshot.ref.getDownloadURL();
                    });
                });

                // Ждем, пока все файлы загрузятся
                const downloadedUrls = await Promise.all(uploadPromises);
                imageUrls.push(...downloadedUrls);
                
                showStatus('Сохранение статьи...', 'loading');

                // Добавляем документ в Firestore
                await db.collection('comics').add({
                    title: title,
                    imageUrls: imageUrls,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showStatus('Статья успешно создана!', 'success');
                form.reset(); // Очищаем форму

            } catch (error) {
                console.error("Ошибка при создании статьи: ", error);
                showStatus('Произошла ошибка. Попробуйте еще раз.', 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>